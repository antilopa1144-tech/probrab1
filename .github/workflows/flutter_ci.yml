name: Flutter CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  analyze:
    name: ðŸ“Š Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ” Verify formatting
        run: dart format --set-exit-if-changed .

      - name: ðŸ“Š Analyze code
        run: flutter analyze --fatal-infos

      - name: âœ… Check for TODOs
        run: |
          TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK" lib --include="*.dart" | wc -l || echo "0")
          echo "Found $TODO_COUNT technical debt markers"
          if [ "$TODO_COUNT" -gt 20 ]; then
            echo "âš ï¸ Warning: Too many TODOs ($TODO_COUNT > 20)"
            exit 1
          fi

  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: analyze

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ§ª Run all tests
        run: flutter test --coverage --reporter expanded

      - name: ðŸ“Š Generate coverage report
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          lcov --summary coverage/lcov.info

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: âœ… Check coverage threshold
        run: |
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âš ï¸ Coverage below 90% threshold"
            exit 1
          fi

      - name: ðŸ’¾ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/

  integration-test:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”— Run integration tests
        run: flutter test integration_test/
        continue-on-error: true

  build-android:
    name: ðŸ¤– Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build APK
        run: flutter build apk --release

      - name: ðŸ’¾ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  build-ios:
    name: ðŸŽ Build iOS
    runs-on: macos-latest
    timeout-minutes: 45
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
        continue-on-error: true

  dependency-check:
    name: ðŸ“¦ Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ”’ Check for outdated dependencies
        run: flutter pub outdated --show-all
        continue-on-error: true

      - name: ðŸ” Audit dependencies
        run: dart pub audit
        continue-on-error: true

  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [analyze, test, integration-test]
    if: always()

    steps:
      - name: âœ… Success notification
        if: ${{ needs.analyze.result == 'success' && needs.test.result == 'success' }}
        run: |
          echo "ðŸŽ‰ All checks passed!"
          echo "âœ… Code analysis: PASSED"
          echo "âœ… Tests: PASSED"
          echo "âœ… Integration tests: PASSED"

      - name: âŒ Failure notification
        if: ${{ needs.analyze.result == 'failure' || needs.test.result == 'failure' }}
        run: |
          echo "âŒ Some checks failed!"
          echo "Analysis: ${{ needs.analyze.result }}"
          echo "Tests: ${{ needs.test.result }}"
          exit 1
